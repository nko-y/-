#### 八叉树

（1）原理：

- 对于点物体。将空间依次等分为八个相等的子空间，直到达到一定深度或满足节点包含的元素小于一点数量
- 对于有体积的物体。对物体使用球包围盒或AABB包围盒或OBB包围盒
  - 边界相交：一种方法是每个节点都存储这个物体(大体积的物体就会被很多叶子节点引用)，另一种方法是令中间节点(非叶节点)放置物体(常用方法，如果物体正好位于场景中心，即使体积很小的物体也需要放在根节点中)
  - 松散八叉树，扩大包围盒定义入口边界和出口边界(入口=出口×2)
    - 若物体还没有添加进入八叉树，就检测位于哪个节点的入口边界
    - 若物体已经添加进入八叉树，就根据物体是否越出出口边界，若越出则再检测位于哪个入口边界

（2）优劣： 

- 在空间数据对象分布比较均匀时，有较高的插入和查询效率，复杂度O(logN)。反之如果所有的点集中在一起就起不到加速作用了



#### BVH

（1）原理：

- 先找到一个包围盒包围住场景内的物体
- 递归分解包围盒。
  - 选择最长轴，选择中间三角形(可以一开始就排好序，也可以快速选择算法quicksort选择中间三角形)划分，三角形用重心表示
  - 【为了使得划分的包围盒尽可能地减小重合】SAH，考虑将所有的物体分为两个包围盒光线击中他们的概率分别为 $p(A)$ 和 $p(B)$ ，由于包围盒有相交他们的概率和不一定为1，此时求交点的代价是 $c(A,B)=p(A)\sum_{i\in A}t(i)+p(B)\sum_{j\in B}t(j)+t_{trav}$ 简化后 $c(A,B)=\frac{S(A)}{S(C)}a+\frac{S(B)}{S(C)}b$ S代表表面积，实际计算起来沿着轴均分n段计算代价最小值 
- 计算每个包围盒的坐标范围，当包围盒足够小时算法结束，并在叶节点存储场景内物体的信息

（2）光线求交

- 光线与包围盒求交：将光线表示为 $o+td$ 形式，分别与AABB的三对平行面求交，相交的较小值为 $t_{min}$ 较大值为 $t_{max}$ 如果 $max\{t_{min}^x, t_{min}^y, t_{min}^z \} \leq min\{t_{max}^x, t_{max}^y, t_{max}^z \}$ 则说明有交点
- 光线与三角形求交：先求光线与三角形所在平面交点，如果该点位于三角形内则说明有交点

（3）并行构建BVH：

- 使用morton code表示每个点在空间中的排序，本质上是将空间划分为 $n\times n\times n$ 的格子为每个格子分配一个morton code(少量格子存在大量重复数据)
- 相同前缀的位数表示节点的相近程度，某一位发生改变说明该节点为树的一个内部节点。
- 有了内部节点就可以并行的从底向上构建BVH了

（4）优劣：

- BVH构建相对较慢，往往需要知道所有物体的信息后才能构建不便于动态更新，但光线求交会更快
- BVH常常用于碰撞检测中



#### KDTree树

（1）原理：选择方差最大轴并以中位数点为分割线将空间划分为两部分，循环直至该空间内只包含一个点

（2）优劣：

- 便于寻找最邻近的点
- 适用于处理相对稠密的数据



#### BSP树

（1）原理：不必轴对齐的KDTree，(可以先构建一棵球体树(用球体构建BVH)用于加速)，选择一个平面使得在平面前的平面形状数和平面后的平面形状数尽可能地接近。若划分的平面与其相交则切割成两个子形状，重复此过程

- 判断点在平面前后算法：写出平面方程 $Ax+By+Cz+D=0$ 带入点坐标如果坐标值大于0则在前方小于0在后方

（2）应用：室内场景视锥剔除、几何体编辑(Constructive Solid Geometry)、自动生成导航网格



参考文献：

1. [空间数据结构(四叉树/八叉树/BVH树/BSP树/k-d树) ](https://www.cnblogs.com/KillerAery/p/10878367.html)
2. [游戏场景管理的八叉树算法是怎样的？](https://www.zhihu.com/question/25111128/answer/30129131)
3. [PBRT-E4.3-层次包围体(BVH)（一）](https://zhuanlan.zhihu.com/p/50720158)
4. [并行构建BVH](https://zhuanlan.zhihu.com/p/97056642)
5. [Bounding Volume Hierachy of pbrt 解析(2) HLBVH](https://wyman1024.github.io/bvh-2/)
6. [CUDA学习笔记：并行构造BVH](https://zhuanlan.zhihu.com/p/423351818)
7. [游戏场景管理中BVH相比于八叉树有什么劣势](https://www.zhihu.com/question/48905832)
8. [【量化课堂】kd树算法之详细篇](https://www.joinquant.com/view/community/detail/c2c41c79657cebf8cd871b44ce4f5d97)























